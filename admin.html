<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moderators Dashboard ‚Äì Scar Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --primary: #38bdf8;
      --primary-soft: rgba(56, 189, 248, 0.12);
      --primary-strong: rgba(56, 189, 248, 0.25);
      --accent: #22c55e;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.12);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
      --shadow-sm: 0 10px 25px rgba(15, 23, 42, 0.7);
      --scrollbar: #4b5563;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #0b1120, #020617 55%);
      min-height: 100vh;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .shell {
      width: 100%;
      max-width: 1100px;
      padding: 24px 16px 32px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.1), transparent 55%),
                  radial-gradient(circle at top right, rgba(34, 197, 94, 0.08), transparent 50%),
                  #020617;
      border-radius: 22px;
      padding: 20px 18px 22px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(15, 23, 42, 0.85);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,0.07), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(34,197,94,0.05), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
    }

    .header-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .header-title h1 {
      font-size: 20px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-title h1 span {
      font-size: 22px;
    }

    .header-title p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--danger);
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.7);
    }

    .status-pill.ok .status-dot {
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .status-pill span {
      color: var(--text-main);
    }

    .filters {
      margin-bottom: 14px;
      border-radius: 16px;
      padding: 14px 12px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.95) 40%, #020617 100%);
      border: 1px solid rgba(55, 65, 81, 0.8);
      box-shadow: var(--shadow-sm);
    }

    /* === ÿ™ÿπÿØŸäŸÑ ŸÖŸÇÿßÿ≥ ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿ®ÿ™ÿßÿπÿ© ÿßŸÑŸÅŸÑÿßÿ™ÿ± === */
    .filters-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr 1.2fr 0.9fr 0.9fr; /* ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸÇÿØ ÿ®ÿπÿ∂ ŸàÿßŸÑÿ®ÿßŸÇŸä ÿ£ŸÇÿµÿ± ÿ¥ŸàŸäÿ© */
      gap: 10px;
      align-items: end;
    }

    .filter-group label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    select,
    input[type="date"],
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    select:focus,
    input[type="date"]:focus,
    input[type="text"]:focus,
    input[type="password"]:focus {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
      background: rgba(15, 23, 42, 1);
    }

    select {
      padding-right: 26px;
    }

    .filters-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 13px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.1s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0b1120;
      box-shadow: 0 10px 20px rgba(56, 189, 248, 0.4);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(56, 189, 248, 0.55);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      color: var(--text-main);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 11px;
    }

    .btn-block-mobile {
      width: auto;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 9px 5px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge strong {
      color: var(--text-main);
      font-weight: 600;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .badge-dot.blue {
      background: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.9);
    }

    .badge-dot.green {
      background: rgba(34, 197, 94, 0.9);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .badge-dot.purple {
      background: rgba(168, 85, 247, 0.9);
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.9);
    }

    .badge-dot.red {
      background: rgba(248, 113, 113, 0.9);
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.9);
    }

    .table-wrapper {
      border-radius: 16px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98) 40%, #020617 100%);
      border: 1px solid rgba(55, 65, 81, 0.9);
      overflow-x: auto;
      box-shadow: var(--shadow-sm);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 700px;
    }

    thead {
      background: linear-gradient(90deg, rgba(15,23,42,0.98), rgba(15,23,42,1));
    }

    thead th {
      padding: 10px 9px;
      font-weight: 500;
      color: var(--text-muted);
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.9);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.97);
    }

    tbody td {
      padding: 8px 9px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      color: var(--text-main);
      white-space: nowrap;
    }

    tbody tr:hover {
      background: rgba(15, 23, 42, 1);
    }

    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 11px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.98);
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions-cell {
      display: flex;
      gap: 6px;
    }

    .btn-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      background: rgba(15, 23, 42, 0.95);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-muted);
      transition: background 0.15s ease, transform 0.05s ease;
    }

    .btn-icon:hover {
      background: rgba(31, 41, 55, 1);
      color: var(--text-main);
      transform: translateY(-1px);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
    }

    .pill-dot.green {
      background: rgba(34, 197, 94, 0.9);
    }

    .pill-dot.yellow {
      background: rgba(234, 179, 8, 0.9);
    }

    .pill-dot.red {
      background: rgba(248, 113, 113, 0.9);
    }

    .error-box {
      display: none;
      margin-top: 10px;
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 12px;
      background: var(--danger-soft);
      border: 1px solid rgba(248, 113, 113, 0.6);
      color: #fecaca;
    }

    .error-box strong {
      color: #fee2e2;
    }

    .login-shell {
      max-width: 360px;
      margin: 40px auto 80px;
    }

    .login-card {
      border-radius: 20px;
      padding: 22px 18px 20px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.98) 40%, #020617 100%);
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: var(--shadow-soft);
    }

    .login-card h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .login-card p {
      margin: 0 0 14px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .login-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    .login-error {
      display: none;
      margin-bottom: 10px;
      font-size: 11px;
      color: #fecaca;
      padding: 7px 9px;
      border-radius: 10px;
      background: var(--danger-soft);
      border: 1px solid rgba(248, 113, 113, 0.6);
    }

    .connection {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .connection span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .connection small {
      color: var(--text-muted);
    }

    .connection .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--danger);
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.8);
    }

    .connection.ok .dot {
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.95);
    }

    .connection.ok small {
      color: #bbf7d0;
    }

    .footer {
      margin-top: 18px;
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.85;
    }

    /* === Overlay panel ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÄ Booking data === */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.88);
      backdrop-filter: blur(6px);
      z-index: 999;
    }

    .overlay-panel {
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.99) 40%, #020617 100%);
      border-radius: 20px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: var(--shadow-soft);
      width: 100%;
      max-width: 1000px;
      max-height: calc(100vh - 80px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .overlay-header {
      padding: 14px 16px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    .overlay-header h2 {
      margin: 0;
      font-size: 16px;
    }

    .overlay-header p {
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .overlay-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .overlay-body {
      padding: 10px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }

    .overlay-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .overlay-table-wrapper {
      flex: 1;
      min-height: 0;
      border-radius: 14px;
      overflow: auto;
    }

    .overlay table {
      font-size: 11px;
      min-width: 750px;
    }

    @media (max-width: 900px) {
      body {
        align-items: stretch;
      }

      .shell {
        padding: 16px 12px 24px;
      }

      .card {
        padding: 16px 14px 18px;
      }

      .filters-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .connection {
        justify-content: flex-start;
      }

      .filters-actions {
        justify-content: flex-start;
      }

      .btn-block-mobile {
        width: 100%;
        justify-content: center;
      }

      .overlay-panel {
        max-width: calc(100% - 20px);
      }
    }

    @media (max-width: 640px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }

      .shell {
        padding: 16px 10px 22px;
      }

      .card {
        border-radius: 18px;
      }

      table {
        font-size: 11px;
        min-width: 650px;
      }

      .table-footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #020617;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 999px;
    }
  </style>
</head>
<body>
<div class="shell">

  <!-- Login Shell -->
  <div id="loginShell" class="login-shell">
    <div class="login-card">
      <h2>Moderators Dashboard ‚Äì Scar Group</h2>
      <p>Sign in with your moderator credentials to view and export daily reports.</p>

      <form id="loginForm">
        <div class="login-grid">
          <div class="filter-group">
            <label for="loginUsername">Username</label>
            <input id="loginUsername" type="text" autocomplete="username" />
          </div>
          <div class="filter-group">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" autocomplete="current-password" />
          </div>
        </div>

        <div id="loginError" class="login-error">
          Invalid username or password. Please try again.
        </div>

        <button type="submit" class="btn btn-primary btn-block-mobile">
          Sign in
        </button>
      </form>

      <div class="connection" id="connectionStatus">
        <span>
          <span class="dot"></span>
          <small id="connectionText">Not connected</small>
        </span>
      </div>
    </div>
  </div>

  <!-- Dashboard Shell -->
  <div id="dashboardShell" style="display:none;">
    <div class="card">
      <div class="card-inner">

        <div class="header">
          <div class="header-title">
            <h1>
              <span>üìä</span> Moderators Daily Reports
            </h1>
            <p>Review and export moderators daily performance with live data from Firestore.</p>
          </div>

          <div class="status-pill" id="statusPill">
            <span class="status-dot"></span>
            <span>Loading...</span>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filters-grid">
            <div class="filter-group">
              <label for="filterModerator">Moderator</label>
              <select id="filterModerator">
                <option value="All">All</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="filterNew">New client?</label>
              <select id="filterNew">
                <option value="All">All</option>
                <option value="New">New only</option>
                <option value="NotNew">Not New</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="dateFilterMode">Filter by</label>
              <select id="dateFilterMode">
                <option value="report">Report date</option>
                <option value="session">Session date</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="fromDate">From date</label>
              <input type="date" id="fromDate" />
            </div>

            <div class="filter-group">
              <label for="toDate">To date</label>
              <div class="filters-actions">
                <input type="date" id="toDate" style="flex:1; min-width:0;" />
                <button type="button" id="resetFiltersBtn" class="btn btn-secondary btn-small" style="margin-left:4px;">
                  Reset
                </button>
                <button type="button" id="applyFiltersBtn" class="btn btn-primary btn-small">
                  Apply
                </button>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:4px; margin-bottom:8px; display:flex; flex-wrap:wrap; gap:8px;">
          <button type="button" id="downloadPerformanceBtn" class="btn btn-secondary btn-block-mobile">
            üì• Download performance PDF (current filter)
          </button>
          <!-- ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÜÿµ ŸÑŸÄ Booking data -->
          <button type="button" id="downloadBookingsBtn" class="btn btn-secondary btn-block-mobile">
            üìä Booking data
          </button>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
          <table>
            <thead>
            <tr>
              <th>Date</th>
              <th>Moderator</th>
              <th>Shift</th>
              <th>Total clients</th>
              <th>Total new</th>
              <th>Scar</th>
              <th>You</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="reportsBody">
            </tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="badge">
            <span class="badge-dot blue"></span>
            Reports loaded: <strong id="reportsCount">0</strong>
          </div>
          <div class="badge">
            <span class="badge-dot green"></span>
            Total clients in filter: <strong id="totalClientsFiltered">0</strong>
          </div>
        </div>

        <div id="errorBox" class="error-box">
          <strong>Connection error:</strong> Unable to load reports at the moment. Please refresh the page or check your connection.
        </div>

      </div>
    </div>
  </div>

  <!-- Overlay Panel ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÄ Booking data -->
  <div id="bookingsOverlay" class="overlay">
    <div class="overlay-panel">
      <div class="overlay-header">
        <div class="overlay-header-left">
          <h2>Booking data</h2>
          <p>Preview, mark attendance, and export Excel for the current filter.</p>
        </div>
        <button type="button" id="closeBookingsOverlay" class="btn-icon" title="Close">
          ‚úï
        </button>
      </div>
      <div class="overlay-body">
        <div class="overlay-actions">
          <button type="button" id="saveAttendanceBtn" class="btn btn-primary btn-small">
            üíæ Save
          </button>
          <button type="button" id="downloadExcelFromOverlayBtn" class="btn btn-secondary btn-small">
            üìä Download Excel sheet
          </button>
        </div>

        <div class="table-wrapper overlay-table-wrapper">
          <table>
            <thead>
            <tr>
              <th>Report Date</th>
              <th>Moderator</th>
              <th>Client Name</th>
              <th>Phone</th>
              <th>Session No.</th>
              <th>Session Date</th>
              <th>Service</th>
              <th>Branch</th>
              <th>Attended</th>
              <th>New?</th>
            </tr>
            </thead>
            <tbody id="bookingsPreviewBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Footer -->
  <footer class="footer">
    ¬© Mods Online Web App - Developed By AB Graphics and More - By Mohamed Hakim - Baraa Atef - Zaki Radwan
  </footer>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    orderBy,
    query
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpG7Ja5HCfU2RnGJuxXU5ypPA7JKgYY7U",
    authDomain: "clinic-725a7.firebaseapp.com",
    projectId: "clinic-725a7",
    storageBucket: "clinic-725a7.firebasestorage.app",
    messagingSenderId: "644725580556",
    appId: "1:644725580556:web:a5947d966e711888125f29",
    measurementId: "G-82J5FZ1M07"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const connectionStatus = document.getElementById("connectionStatus");
  const connectionText = document.getElementById("connectionText");
  const statusPill = document.getElementById("statusPill");

  const filterModerator = document.getElementById("filterModerator");
  const filterNew = document.getElementById("filterNew");
  const dateFilterMode = document.getElementById("dateFilterMode");
  const fromDateInput = document.getElementById("fromDate");
  const toDateInput = document.getElementById("toDate");
  const resetFiltersBtn = document.getElementById("resetFiltersBtn");
  const applyFiltersBtn = document.getElementById("applyFiltersBtn");
  const downloadPerformanceBtn = document.getElementById("downloadPerformanceBtn");
  const downloadBookingsBtn = document.getElementById("downloadBookingsBtn");

  const reportsBody = document.getElementById("reportsBody");
  const reportsCountSpan = document.getElementById("reportsCount");
  const totalClientsFilteredSpan = document.getElementById("totalClientsFiltered");
  const errorBox = document.getElementById("errorBox");

  const loginShell = document.getElementById("loginShell");
  const dashboardShell = document.getElementById("dashboardShell");
  const loginForm = document.getElementById("loginForm");
  const loginUsername = document.getElementById("loginUsername");
  const loginPassword = document.getElementById("loginPassword");
  const loginError = document.getElementById("loginError");

  // ÿπŸÜÿßÿµÿ± ÿßŸÑŸÄ overlay
  const bookingsOverlay = document.getElementById("bookingsOverlay");
  const bookingsPreviewBody = document.getElementById("bookingsPreviewBody");
  const closeBookingsOverlayBtn = document.getElementById("closeBookingsOverlay");
  const saveAttendanceBtn = document.getElementById("saveAttendanceBtn");
  const downloadExcelFromOverlayBtn = document.getElementById("downloadExcelFromOverlayBtn");

  // ÿ´ÿßÿ®ÿ™ ŸÑŸÑŸäŸàÿ≤ÿ±ŸÜŸäŸÖ ŸàÿßŸÑÿ®ÿßÿ≥Ÿàÿ±ÿØÿßÿ™
  const VALID_USERS = {
    "islam": "gasd53ds4fs5dg34",
    "andrew": "5345asd54fffdg23",
    "baraa": "21354adfs54g1sf5",
    "hakim": "123",
    "admin": "fg2hd5435ads4as5",
    "engy": "asdfighy321df3as"
  };

  let allReports = [];
  let filteredReports = [];
  let isDashboardInitialized = false;

  const FOOTER_TEXT = "¬© Mods Online Web App - Developed By AB Graphics and More - By Mohamed Hakim - Baraa Atef - Zaki Radwan";

  /* ====== ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÄ Attended ŸÅŸä localStorage ====== */
  const ATTENDED_STORAGE_KEY = "mods_attended_v1";
  let attendedMap = {};

  function loadAttendedFromStorage() {
    try {
      const raw = localStorage.getItem(ATTENDED_STORAGE_KEY);
      attendedMap = raw ? JSON.parse(raw) : {};
    } catch {
      attendedMap = {};
    }
  }

  function saveAttendedToStorage() {
    try {
      localStorage.setItem(ATTENDED_STORAGE_KEY, JSON.stringify(attendedMap));
    } catch {
      // ignore
    }
  }

  function getBookingKey(report, booking) {
    return [
      report.id || "",
      booking.sessionNumber || "",
      booking.phone || "",
      booking.sessionDate || "",
      booking.name || ""
    ].join("|");
  }

  function isBookingAttended(report, booking) {
    const key = getBookingKey(report, booking);
    return !!attendedMap[key];
  }

  function setBookingAttended(report, booking, value) {
    const key = getBookingKey(report, booking);
    if (value) {
      attendedMap[key] = true;
    } else {
      delete attendedMap[key];
    }
  }

  loadAttendedFromStorage();

  function setConnectionStatus(ok, msg) {
    connectionStatus.classList.toggle("error", !ok);
    connectionStatus.classList.toggle("ok", ok);
    connectionText.textContent = msg;
    statusPill.classList.toggle("ok", ok);
    statusPill.querySelector("span:nth-child(2)").textContent = ok ? "Connected to Firestore" : "Not connected";
  }

  function formatCreatedAt(ts) {
    if (!ts) return "-";
    try {
      const date = ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000);
      return date.toLocaleString("en-GB", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    } catch {
      return "-";
    }
  }

  // New client flag
  function bookingIsNew(b) {
    if (!b) return false;
    const raw = b.isNew ?? b.new ?? b.isNewClient ?? "";
    if (typeof raw === "string") {
      const v = raw.trim().toLowerCase();
      return v === "new" || v === "yes";
    }
    if (typeof raw === "boolean") return raw;
    if (typeof raw === "number") return raw === 1;
    return false;
  }

  function applyFilters() {
    errorBox.style.display = "none";

    const mod = filterModerator.value;
    const newFilter = filterNew.value;
    const from = fromDateInput.value;
    const to = toDateInput.value;
    const dateMode = dateFilterMode.value || "report";

    const newFilteredReports = [];

    allReports.forEach((r) => {
      if (mod !== "All" && r.moderator !== mod) return;

      const bookingsArray = Array.isArray(r.bookings) ? r.bookings : [];

      let passesReportDate = true;
      if (dateMode === "report") {
        if (from && r.date && r.date < from) passesReportDate = false;
        if (to && r.date && r.date > to) passesReportDate = false;
      }

      if (dateMode === "report" && !passesReportDate) {
        return;
      }

      const filteredBookings = bookingsArray.filter((b) => {
        const isNew = bookingIsNew(b);

        if (newFilter === "New" && !isNew) return false;
        if (newFilter === "NotNew" && isNew) return false;

        if (dateMode === "session") {
          const dateStr = b.sessionDate || "";
          if (from && dateStr && dateStr < from) return false;
          if (to && dateStr && dateStr > to) return false;
        }

        return true;
      });

      let includeReport = true;
      if (dateMode === "session") {
        includeReport = filteredBookings.length > 0;
      } else {
        if (newFilter === "New" || newFilter === "NotNew") {
          includeReport = filteredBookings.length > 0;
        }
      }

      if (!includeReport) return;

      let visibleTotals;
      let visibleTotalNew;

      const baseBookingsForTotals =
        (dateMode === "session" || newFilter !== "All") && filteredBookings.length
          ? filteredBookings
          : bookingsArray;

      if (baseBookingsForTotals.length) {
        let total = 0, scar = 0, you = 0, totalNew = 0;
        baseBookingsForTotals.forEach((b) => {
          total++;
          if (bookingIsNew(b)) totalNew++;
          const branch = (b.branch || r.branch || r.clinic || "").toLowerCase();
          if (branch.includes("you")) you++;
          else scar++;
        });
        visibleTotals = { total, scar, you };
        visibleTotalNew = totalNew;
      } else {
        visibleTotals = r.totals || { total: 0, scar: 0, you: 0 };
        visibleTotalNew = r.totalNew ?? 0;
      }

      const visibleBookings = (dateMode === "session" || newFilter !== "All")
        ? filteredBookings
        : bookingsArray;

      newFilteredReports.push({
        ...r,
        visibleBookings,
        visibleTotals,
        visibleTotalNew
      });
    });

    filteredReports = newFilteredReports;
    renderTable();
  }

  function renderTable() {
    reportsBody.innerHTML = "";
    let totalClients = 0;

    filteredReports.forEach((report) => {
      const tr = document.createElement("tr");

      const dateTd = document.createElement("td");
      dateTd.textContent = report.date || "-";
      tr.appendChild(dateTd);

      const modTd = document.createElement("td");
      modTd.textContent = report.moderator || "-";
      tr.appendChild(modTd);

      const shiftTd = document.createElement("td");
      shiftTd.textContent = report.shiftLabel || report.shift || "-";
      tr.appendChild(shiftTd);

      const totalTd = document.createElement("td");
      const totalNewTd = document.createElement("td");
      const scarTd = document.createElement("td");
      const youTd = document.createElement("td");

      const tot = report.visibleTotals || report.totals || {};
      const totalNew = report.visibleTotalNew ?? report.totalNew ?? 0;

      totalTd.textContent = (tot.total ?? 0).toString();
      totalNewTd.textContent = totalNew.toString();
      scarTd.textContent = (tot.scar ?? 0).toString();
      youTd.textContent = (tot.you ?? 0).toString();
      totalClients += tot.total ?? 0;

      tr.appendChild(totalTd);
      tr.appendChild(totalNewTd);
      tr.appendChild(scarTd);
      tr.appendChild(youTd);

      const createdTd = document.createElement("td");
      createdTd.textContent = formatCreatedAt(report.createdAt);
      tr.appendChild(createdTd);

      const actionsTd = document.createElement("td");
      actionsTd.className = "actions-cell";

      const viewBtn = document.createElement("button");
      viewBtn.className = "btn-icon";
      viewBtn.title = "Download single report PDF (current filter)";
      viewBtn.textContent = "‚¨á";
      viewBtn.addEventListener("click", () => downloadSingleReportPDF(report));
      actionsTd.appendChild(viewBtn);

      tr.appendChild(actionsTd);

      reportsBody.appendChild(tr);
    });

    reportsCountSpan.textContent = filteredReports.length.toString();
    totalClientsFilteredSpan.textContent = totalClients.toString();
  }

  function addFooterToAllPages(doc) {
    const pageCount = doc.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text(FOOTER_TEXT, 14, pageHeight - 8);
    }
  }

  function downloadSingleReportPDF(report) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const {
      moderator,
      date,
      shiftLabel,
      cover,
      checkIn,
      checkOut,
      totals,
      clinic
    } = report;

    const bookingsArray = Array.isArray(report.visibleBookings || report.bookings)
      ? (report.visibleBookings || report.bookings)
      : [];

    let y = 14;
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text(`Moderators Daily Report ‚Äì ${clinic || "Scar Group"}`, 14, y);
    y += 8;

    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.text(`Moderator: ${moderator || "-"}`, 14, y); y += 6;
    doc.text(`Date: ${date || "-"}`, 14, y); y += 6;
    doc.text(`Shift: ${shiftLabel || "-"}`, 14, y); y += 6;

    if (cover) {
      doc.text(`Covering for: ${cover.coverFor || "-"}`, 14, y); y += 6;
      doc.text(`Covered shift: ${cover.coverShiftLabel || cover.coverShift || "-"}`, 14, y); y += 6;
    }

    doc.text(`Check In: ${checkIn?.formatted || "-"}`, 14, y); y += 6;
    if (checkIn && checkIn.diffMinutes != null) {
      const d = checkIn.diffMinutes;
      const txt = d > 2 ? `Late by ${Math.round(d)} min`
        : d < -2 ? `Early by ${Math.abs(Math.round(d))} min`
        : "On time";
      doc.text(`Check In status: ${txt}`, 14, y); y += 6;
    }

    doc.text(`Check Out: ${checkOut?.formatted || "-"}`, 14, y); y += 6;
    if (checkOut && checkOut.diffMinutes != null) {
      const d = checkOut.diffMinutes;
      const txt = d > 2 ? `Late by ${Math.round(d)} min`
        : d < -2 ? `Early by ${Math.abs(Math.round(d))} min`
        : "On time";
      doc.text(`Check Out status: ${txt}`, 14, y); y += 8;
    } else {
      y += 4;
    }

    doc.setFont("helvetica", "bold");
    doc.text("Clients Summary (current filter)", 14, y); y += 6;
    doc.setFont("helvetica", "normal");

    const totalNew = bookingsArray.reduce((acc, b) => acc + (bookingIsNew(b) ? 1 : 0), 0);
    const visTotals = report.visibleTotals || totals || { total: 0, scar: 0, you: 0 };

    doc.text(`Total clients: ${visTotals.total ?? 0}`, 14, y); y += 5;
    doc.text(`Total new: ${totalNew}`, 14, y); y += 5;
    doc.text(`Scar Clinic clients: ${visTotals.scar ?? 0}`, 14, y); y += 5;
    doc.text(`You Clinic clients: ${visTotals.you ?? 0}`, 14, y); y += 6;

    const tableBody = bookingsArray.map((b, idx) => [
      (idx + 1).toString(),
      b.name || "",
      b.phone || "",
      b.sessionNumber || "",
      b.sessionDate || "",
      b.service || "",
      b.platform || "",
      b.branch || "",
      b.marked || "",
      bookingIsNew(b) ? "New" : ""
    ]);

    doc.autoTable({
      startY: y,
      head: [["#", "Name", "Phone", "Session No.", "Session Date", "Service", "Platform", "Branch", "Marked", "New?"]],
      body: tableBody,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [56, 189, 248] }
    });

    addFooterToAllPages(doc);

    const fileName = `${moderator || "Moderator"}-${date || "report"}-ScarGroup.pdf`;
    doc.save(fileName);
  }

  function downloadPerformancePDF() {
    if (!filteredReports.length) {
      alert("No reports in current filter.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let y = 14;
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text("Moderators Performance ‚Äì Scar Group", 14, y);
    y += 8;

    doc.setFontSize(10);
    const mod = filterModerator.value;
    const from = fromDateInput.value || "Any";
    const to = toDateInput.value || "Any";
    const newFilter = filterNew.value || "All";
    const dateModeLabel = dateFilterMode.value === "session" ? "Session Date" : "Report Date";
    doc.text(
      `Filter ‚Äì Moderator: ${mod}, New: ${newFilter}, Date mode: ${dateModeLabel}, From: ${from}, To: ${to}`,
      14,
      y
    );
    y += 8;

    let totalClients = 0;
    let totalScar = 0;
    let totalYou = 0;
    let totalNew = 0;

    filteredReports.forEach((r) => {
      const vt = r.visibleTotals || r.totals || {};
      totalClients += (vt.total || 0);
      totalScar += (vt.scar || 0);
      totalYou += (vt.you || 0);
      totalNew += (r.visibleTotalNew ?? r.totalNew ?? 0);
    });

    doc.setFont("helvetica", "bold");
    doc.text("Summary (current filter)", 14, y); y += 6;
    doc.setFont("helvetica", "normal");
    doc.text(`Reports: ${filteredReports.length}`, 14, y); y += 5;
    doc.text(`Total clients: ${totalClients}`, 14, y); y += 5;
    doc.text(`Total new clients: ${totalNew}`, 14, y); y += 5;
    doc.text(`Scar Clinic: ${totalScar}`, 14, y); y += 5;
    doc.text(`You Clinic: ${totalYou}`, 14, y); y += 8;

    const tableBody = filteredReports.map((r) => {
      const vt = r.visibleTotals || r.totals || {};
      const tNew = r.visibleTotalNew ?? r.totalNew ?? 0;
      return [
        r.date || "",
        r.moderator || "",
        r.shiftLabel || "",
        vt.total ?? 0,
        tNew,
        vt.scar ?? 0,
        vt.you ?? 0,
      ];
    });

    doc.autoTable({
      startY: y,
      head: [["Date", "Moderator", "Shift", "Total", "Total New", "Scar", "You"]],
      body: tableBody,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [56, 189, 248] }
    });

    addFooterToAllPages(doc);

    const fileName = `Moderators-Performance-${mod}-${from}-${to}-ScarGroup.pdf`;
    doc.save(fileName);
  }

  /* ====== ÿ®ŸÜÿßÿ° ÿ¨ÿØŸàŸÑ ÿßŸÑŸÄ overlay ŸÖŸÜ ŸÜŸÅÿ≥ ÿßŸÑÿØÿßÿ™ÿß ÿ®ÿ™ÿßÿπÿ© Excel ====== */
  function buildBookingsPreviewTable() {
    bookingsPreviewBody.innerHTML = "";

    const rows = [];

    filteredReports.forEach((report) => {
      const reportDate = report.date || "";
      const bookings = Array.isArray(report.visibleBookings || report.bookings)
        ? (report.visibleBookings || report.bookings)
        : [];

      bookings.forEach((b) => {
        rows.push({
          report,
          booking: b,
          data: {
            "Report Date": reportDate,
            "Moderator": report.moderator || "",
            "Client Name": b.name || "",
            "Phone": b.phone || "",
            "Session No.": b.sessionNumber || "",
            "Session Date": b.sessionDate || "",
            "Service": b.service || "",
            "Branch": b.branch || report.branch || report.clinic || "",
            "New?": bookingIsNew(b) ? "New" : ""
          }
        });
      });
    });

    // ŸÜŸÅÿ≥ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÄ Excel: ÿ≠ÿ≥ÿ® Session Date
    rows.sort((a, b) => {
      const da = a.data["Session Date"] || "";
      const db = b.data["Session Date"] || "";
      if (!da && !db) return 0;
      if (!da) return 1;
      if (!db) return -1;
      return da.localeCompare(db);
    });

    rows.forEach(({ report, booking, data }) => {
      const tr = document.createElement("tr");

      const headerOrder = [
        "Report Date",
        "Moderator",
        "Client Name",
        "Phone",
        "Session No.",
        "Session Date",
        "Service",
        "Branch"
      ];

      headerOrder.forEach((h) => {
        const td = document.createElement("td");
        td.textContent = data[h] || "";
        tr.appendChild(td);
      });

      // Attended checkbox
      const attendedTd = document.createElement("td");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = isBookingAttended(report, booking);
      cb.addEventListener("change", () => {
        setBookingAttended(report, booking, cb.checked);
        saveAttendedToStorage(); // ŸÜÿ≠ŸÅÿ∏ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿπÿ¥ÿßŸÜ ŸÑŸÖÿß Ÿäÿ±ÿ¨ÿπ ŸäŸÑÿßŸÇŸäŸáÿß ÿ≤Ÿä ŸÖÿß ŸáŸä
      });
      attendedTd.appendChild(cb);
      tr.appendChild(attendedTd);

      // New?
      const newTd = document.createElement("td");
      newTd.textContent = data["New?"] || "";
      tr.appendChild(newTd);

      bookingsPreviewBody.appendChild(tr);
    });
  }

  function openBookingsOverlay() {
    if (!filteredReports.length) {
      alert("No reports in current filter.");
      return;
    }
    buildBookingsPreviewTable();
    bookingsOverlay.style.display = "flex";
    document.body.style.overflow = "hidden";
  }

  function closeBookingsOverlay() {
    bookingsOverlay.style.display = "none";
    document.body.style.overflow = "";
  }

  function downloadBookingsExcel() {
    if (!filteredReports.length) {
      alert("No reports in current filter.");
      return;
    }

    if (typeof XLSX === "undefined") {
      alert("Excel export library (XLSX) is not loaded.");
      return;
    }

    const scarRows = [];
    const youRows = [];

    filteredReports.forEach((report) => {
      const reportDate = report.date || "";
      const bookings = Array.isArray(report.visibleBookings || report.bookings)
        ? (report.visibleBookings || report.bookings)
        : [];

      bookings.forEach((b) => {
        const branch = b.branch || report.branch || report.clinic || "";
        const branchName = (branch || "").toLowerCase();

        const attended = isBookingAttended(report, b) ? "Yes" : "";

        const row = {
          "Report Date": reportDate,
          "Moderator": report.moderator || "",
          "Client Name": b.name || "",
          "Phone": b.phone || "",
          "Session No.": b.sessionNumber || "",
          "Session Date": b.sessionDate || "",
          "Service": b.service || "",
          "Branch": branch || "",
          "Attended": attended,
          "New?": bookingIsNew(b) ? "New" : ""
        };

        if (branchName.includes("you")) {
          youRows.push(row);
        } else {
          scarRows.push(row);
        }
      });
    });

    function sortBySessionDate(rows) {
      rows.sort((a, b) => {
        const da = a["Session Date"] || "";
        const db = b["Session Date"] || "";
        if (!da && !db) return 0;
        if (!da) return 1;
        if (!db) return -1;
        return da.localeCompare(db);
      });
    }

    sortBySessionDate(scarRows);
    sortBySessionDate(youRows);

    const header = [
      "Report Date",
      "Moderator",
      "Client Name",
      "Phone",
      "Session No.",
      "Session Date",
      "Service",
      "Branch",
      "Attended",
      "New?"
    ];

    const wb = XLSX.utils.book_new();
    const scarSheet = XLSX.utils.json_to_sheet(scarRows, { header });
    const youSheet = XLSX.utils.json_to_sheet(youRows, { header });

    function autoFitColumns(ws, rows) {
      const colWidths = header.map(h => h.length);
      rows.forEach(row => {
        header.forEach((h, idx) => {
          const val = row[h] == null ? "" : String(row[h]);
          if (val.length > colWidths[idx]) {
            colWidths[idx] = val.length;
          }
        });
      });
      ws['!cols'] = colWidths.map(wch => ({ wch: wch + 2 }));
    }

    autoFitColumns(scarSheet, scarRows);
    autoFitColumns(youSheet, youRows);

    // ÿ™ŸÑŸàŸäŸÜ ÿÆÿßŸÜÿßÿ™ New ÿßŸÑŸÑŸä ŸÅŸäŸáÿß "New" ÿ®ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿÆÿ∂ÿ± ÿßŸÑŸÅÿßÿ™ÿ≠
    function highlightNew(ws, rows) {
      const newColIndex = header.indexOf("New?");
      if (newColIndex < 0) return;
      rows.forEach((row, idx) => {
        if (row["New?"] === "New") {
          const cellAddress = XLSX.utils.encode_cell({ r: idx + 1, c: newColIndex }); // +1 ŸÑŸÑŸÄ header
          const cell = ws[cellAddress];
          if (cell) {
            cell.s = {
              fill: { fgColor: { rgb: "FFDCFCE7" } } // ÿ£ÿÆÿ∂ÿ± ŸÅÿßÿ™ÿ≠
            };
          }
        }
      });
    }

    highlightNew(scarSheet, scarRows);
    highlightNew(youSheet, youRows);

    XLSX.utils.book_append_sheet(wb, scarSheet, "Scar");
    XLSX.utils.book_append_sheet(wb, youSheet, "You");

    const mod = filterModerator.value || "All";
    const from = fromDateInput.value || "Any";
    const to = toDateInput.value || "Any";
    const mode = dateFilterMode.value === "session" ? "Session" : "Report";
    const fileName = `Bookings-${mod}-${from}-${to}-${mode}.xlsx`;
    XLSX.writeFile(wb, fileName);
  }

  async function loadReports() {
    try {
      setConnectionStatus(true, "Connected");
      errorBox.style.display = "none";
      reportsBody.innerHTML = "";
      reportsCountSpan.textContent = "0";
      totalClientsFilteredSpan.textContent = "0";

      const q = query(collection(db, "reports"), orderBy("createdAt", "desc"));
      const snap = await getDocs(q);

      allReports = snap.docs.map((d) => {
        const data = d.data();
        const bookings = Array.isArray(data.bookings) ? data.bookings : [];
        const totalNew = bookings.reduce((acc, b) => acc + (bookingIsNew(b) ? 1 : 0), 0);
        return {
          id: d.id,
          totalNew,
          ...data
        };
      });

      filteredReports = allReports.slice();

      const moderatorsSet = new Set(["All"]);
      allReports.forEach((r) => {
        if (r.moderator) moderatorsSet.add(r.moderator);
      });

      const currentValue = filterModerator.value || "All";
      filterModerator.innerHTML = "";
      moderatorsSet.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        filterModerator.appendChild(opt);
      });
      if (moderatorsSet.has(currentValue)) {
        filterModerator.value = currentValue;
      }

      applyFilters();

      setConnectionStatus(true, "Connected");
    } catch (e) {
      console.error(e);
      setConnectionStatus(false, "Error");
      errorBox.style.display = "block";
    }
  }

  function initDashboardOnce() {
    if (isDashboardInitialized) return;
    isDashboardInitialized = true;

    applyFiltersBtn.addEventListener("click", applyFilters);
    resetFiltersBtn.addEventListener("click", () => {
      filterModerator.value = "All";
      filterNew.value = "All";
      dateFilterMode.value = "report";
      fromDateInput.value = "";
      toDateInput.value = "";
      applyFilters();
    });

    downloadPerformanceBtn.addEventListener("click", downloadPerformancePDF);

    // ÿ≤ÿ±ÿßÿ± Booking data ŸäŸÅÿ™ÿ≠ ÿßŸÑŸÄ overlay
    downloadBookingsBtn.addEventListener("click", openBookingsOverlay);
    downloadExcelFromOverlayBtn.addEventListener("click", downloadBookingsExcel);
    closeBookingsOverlayBtn.addEventListener("click", closeBookingsOverlay);

    // ÿ≤ÿ±ÿßÿ± Save Ÿäÿ≠ŸÅÿ∏ ÿßŸÑŸÄ attended (ŸáŸà ÿ£ÿµŸÑÿßŸã ÿ®Ÿäÿ™ÿ≠ŸÅÿ∏ ŸÖÿπ ŸÉŸÑ changeÿå ÿ®ÿ≥ ÿØŸá ÿ™ÿ£ŸÉŸäÿØ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ)
    saveAttendanceBtn.addEventListener("click", () => {
      saveAttendedToStorage();
      alert("Attendance saved.");
    });

    // ŸÑŸà ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∂ÿ∫ÿ∑ ÿ®ÿ±ÿß ÿßŸÑÿ®ÿßŸÜŸäŸÑ ŸäŸÇŸÅŸÑ
    bookingsOverlay.addEventListener("click", (e) => {
      if (e.target === bookingsOverlay) {
        closeBookingsOverlay();
      }
    });

    loadReports();
  }

  // Login handler (ÿ®ÿØŸàŸÜ DOMContentLoaded ÿπÿ¥ÿßŸÜ ŸÜÿ™ÿ£ŸÉÿØ ÿ•ŸÜŸá ÿ¥ÿ∫ÿßŸÑ)
  loginForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const usernameInput = (loginUsername.value || "").trim();
    const username = usernameInput.toLowerCase();
    const password = (loginPassword.value || "").trim();

    const expectedPassword = VALID_USERS[username];

    if (expectedPassword && expectedPassword === password) {
      loginError.style.display = "none";
      loginShell.style.display = "none";
      dashboardShell.style.display = "block";
      initDashboardOnce();
    } else {
      loginError.style.display = "block";
    }
  });
</script>
</body>
</html>
